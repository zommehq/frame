= Type Guards

The type-guards module provides runtime type checking and message validation utilities for safe TypeScript type narrowing.

== Overview

Type guards enable safe runtime type checking to:

* Prevent runtime type errors
* Enable proper TypeScript type inference
* Validate message structure before processing
* Improve code safety and maintainability

== Import

[source,typescript]
----
import {
  isMessage,
  isInitMessage,
  isReadyMessage,
  isAttributeChangeMessage,
  isEventMessage,
  isCustomEventMessage,
  isFunctionCallMessage,
  isFunctionResponseMessage,
  isFunctionReleaseMessage,
  isFunctionReleaseBatchMessage,
  isValidEventName,
  isSafeAttributeName,
} from '@zomme/fragment-frame';
----

== Message Type Guards

These guards narrow message types for safe property access.

=== `isMessage(value)`

Check if value is a valid Message object.

**Parameters:**
* `value` (unknown) - Value to check

**Returns:** `boolean` - true if value is a Message

**Example:**

[source,typescript]
----
import { isMessage } from '@zomme/fragment-frame';

const data = event.data;

if (isMessage(data)) {
  // data is now typed as Message
  console.log(data.type);
}
----

---

=== `isInitMessage(message)`

Check if message is an InitMessage.

**Parameters:**
* `message` (Message) - Message to check

**Returns:** `boolean` - true if message is InitMessage

**Example:**

[source,typescript]
----
import { isInitMessage, MessageEvent } from '@zomme/fragment-frame';

if (isInitMessage(message)) {
  // message.payload is now typed as FragmentFrameProps
  console.log(message.payload.name);
  console.log(message.payload.base);
}
----

---

=== `isReadyMessage(message)`

Check if message is a ReadyMessage.

**Parameters:**
* `message` (Message) - Message to check

**Returns:** `boolean` - true if message is ReadyMessage

**Example:**

[source,typescript]
----
import { isReadyMessage } from '@zomme/fragment-frame';

if (isReadyMessage(message)) {
  console.log('Fragment is ready');
  this._ready = true;
}
----

---

=== `isAttributeChangeMessage(message)`

Check if message is an AttributeChangeMessage.

**Parameters:**
* `message` (Message) - Message to check

**Returns:** `boolean` - true if message is AttributeChangeMessage

**Example:**

[source,typescript]
----
import { isAttributeChangeMessage } from '@zomme/fragment-frame';

if (isAttributeChangeMessage(message)) {
  // message.attribute and message.value are available
  console.log('Attribute changed:', message.attribute);
  console.log('New value:', message.value);
}
----

---

=== `isEventMessage(message)`

Check if message is an EventMessage.

**Parameters:**
* `message` (Message) - Message to check

**Returns:** `boolean` - true if message is EventMessage

**Example:**

[source,typescript]
----
import { isEventMessage } from '@zomme/fragment-frame';

if (isEventMessage(message)) {
  // message.name and message.data are available
  console.log('Event received:', message.name);
  this._emitLocalEvent(message.name, message.data);
}
----

---

=== `isCustomEventMessage(message)`

Check if message is a CustomEventMessage.

**Parameters:**
* `message` (Message) - Message to check

**Returns:** `boolean` - true if message is CustomEventMessage

**Example:**

[source,typescript]
----
import { isCustomEventMessage } from '@zomme/fragment-frame';

if (isCustomEventMessage(message)) {
  // message.payload.name and message.payload.data are available
  this._dispatchLocalEvent(message.payload.name, message.payload.data);
}
----

---

=== `isFunctionCallMessage(message)`

Check if message is a FunctionCallMessage.

**Parameters:**
* `message` (Message) - Message to check

**Returns:** `boolean` - true if message is FunctionCallMessage

**Example:**

[source,typescript]
----
import { isFunctionCallMessage } from '@zomme/fragment-frame';

if (isFunctionCallMessage(message)) {
  // message.callId, message.fnId, message.params are available
  await this._manager.handleFunctionCall(
    message.callId,
    message.fnId,
    message.params
  );
}
----

---

=== `isFunctionResponseMessage(message)`

Check if message is a FunctionResponseMessage.

**Parameters:**
* `message` (Message) - Message to check

**Returns:** `boolean` - true if message is FunctionResponseMessage

**Example:**

[source,typescript]
----
import { isFunctionResponseMessage } from '@zomme/fragment-frame';

if (isFunctionResponseMessage(message)) {
  // message.callId, message.success, message.result/error are available
  this._manager.handleFunctionResponse(
    message.callId,
    message.success,
    message.result,
    message.error
  );
}
----

---

=== `isFunctionReleaseMessage(message)`

Check if message is a FunctionReleaseMessage.

**Parameters:**
* `message` (Message) - Message to check

**Returns:** `boolean` - true if message is FunctionReleaseMessage

**Example:**

[source,typescript]
----
import { isFunctionReleaseMessage } from '@zomme/fragment-frame';

if (isFunctionReleaseMessage(message)) {
  // message.fnId is available
  this._manager.releaseFunction(message.fnId);
}
----

---

=== `isFunctionReleaseBatchMessage(message)`

Check if message is a FunctionReleaseBatchMessage.

**Parameters:**
* `message` (Message) - Message to check

**Returns:** `boolean` - true if message is FunctionReleaseBatchMessage

**Example:**

[source,typescript]
----
import { isFunctionReleaseBatchMessage } from '@zomme/fragment-frame';

if (isFunctionReleaseBatchMessage(message)) {
  // message.fnIds is available
  for (const fnId of message.fnIds) {
    this._manager.releaseFunction(fnId);
  }
}
----

---

== Security Type Guards

These guards validate names to prevent XSS and prototype pollution attacks.

=== `isValidEventName(name)`

Check if event name is valid (prevents XSS).

**Parameters:**
* `name` (unknown) - Event name to validate

**Returns:** `boolean` - true if event name is valid

**Allowed Characters:**
* Alphanumeric: a-z, A-Z, 0-9
* Special: underscore (_), colon (:), dot (.), dash (-)

**Example:**

[source,typescript]
----
import { isValidEventName } from '@zomme/fragment-frame';

if (!isValidEventName(eventName)) {
  console.warn('Invalid event name:', eventName);
  return;
}

this.dispatchEvent(new CustomEvent(eventName, { detail: data }));
----

---

=== `isSafeAttributeName(name)`

Check if attribute name is safe (prevents prototype pollution).

**Parameters:**
* `name` (unknown) - Attribute name to validate

**Returns:** `boolean` - true if attribute name is safe

**Forbidden Names:**
* `__proto__`
* `constructor`
* `prototype`

**Example:**

[source,typescript]
----
import { isSafeAttributeName } from '@zomme/fragment-frame';

if (!isSafeAttributeName(attributeName)) {
  console.warn('Forbidden attribute name:', attributeName);
  return;
}

Reflect.set(this.props, attributeName, value);
----

---

== Complete Usage Example

[source,typescript]
----
import {
  isMessage,
  isInitMessage,
  isReadyMessage,
  isFunctionCallMessage,
  isFunctionResponseMessage,
  isFunctionReleaseMessage,
  isFunctionReleaseBatchMessage,
} from '@zomme/fragment-frame';
import { MessageEvent } from '@zomme/fragment-frame/constants';

private _handleMessage(message: unknown) {
  // Step 1: Check if it's a valid message
  if (!isMessage(message)) {
    console.warn('Invalid message format:', message);
    return;
  }

  // Step 2: Narrow to specific message type
  if (isInitMessage(message)) {
    console.log('Init message received:', message.payload);
    return;
  }

  if (isReadyMessage(message)) {
    console.log('Ready message received');
    this._ready = true;
    this._dispatchLocalEvent('ready');
    return;
  }

  if (isFunctionCallMessage(message)) {
    await this._manager.handleFunctionCall(
      message.callId,
      message.fnId,
      message.params
    );
    return;
  }

  if (isFunctionResponseMessage(message)) {
    this._manager.handleFunctionResponse(
      message.callId,
      message.success,
      message.result,
      message.error
    );
    return;
  }

  if (isFunctionReleaseMessage(message)) {
    this._manager.releaseFunction(message.fnId);
    return;
  }

  if (isFunctionReleaseBatchMessage(message)) {
    for (const fnId of message.fnIds) {
      this._manager.releaseFunction(fnId);
    }
    return;
  }

  console.warn('Unknown message type:', message.type);
}
----

== Related

* **Message Validators**: See link:./message-validators.adoc[Message Validators] for low-level message validation
* **Source Code**: `src/helpers/type-guards.ts`
